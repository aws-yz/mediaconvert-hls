name: Validate Project

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        # å®‰è£…å¿…éœ€å·¥å…·
        sudo apt-get update
        sudo apt-get install -y curl jq
        
        # éªŒè¯AWS CLIï¼ˆå¦‚æœéœ€è¦ï¼‰
        # aws --version || echo "AWS CLI not available in CI"
        
    - name: Validate shell scripts
      run: |
        # æ£€æŸ¥shellè„šæœ¬è¯­æ³•
        echo "Validating shell scripts..."
        for script in *.sh; do
          if [ -f "$script" ]; then
            echo "Checking $script..."
            bash -n "$script" || exit 1
          fi
        done
        
    - name: Check file permissions
      run: |
        # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æƒé™
        echo "Checking script permissions..."
        for script in *.sh; do
          if [ -f "$script" ] && [ ! -x "$script" ]; then
            echo "Warning: $script is not executable"
          fi
        done
        
    - name: Validate JSON files
      run: |
        # éªŒè¯JSONæ–‡ä»¶æ ¼å¼
        echo "Validating JSON files..."
        for json_file in *.json; do
          if [ -f "$json_file" ]; then
            echo "Checking $json_file..."
            jq empty "$json_file" || exit 1
          fi
        done
        
    - name: Check documentation
      run: |
        # æ£€æŸ¥å¿…éœ€çš„æ–‡æ¡£æ–‡ä»¶
        echo "Checking documentation files..."
        required_docs=("README.md" "QUICK-START-GUIDE.md" "CloudFront-HLS-Setup-Guide.md" "LICENSE")
        for doc in "${required_docs[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "Error: Required documentation file $doc is missing"
            exit 1
          fi
        done
        
    - name: Validate configuration template
      run: |
        # æ£€æŸ¥é…ç½®æ¨¡æ¿
        if [ ! -f ".env.example" ]; then
          echo "Error: .env.example template is missing"
          exit 1
        fi
        
        # æ£€æŸ¥.gitignore
        if [ ! -f ".gitignore" ]; then
          echo "Error: .gitignore is missing"
          exit 1
        fi
        
        # ç¡®ä¿æ•æ„Ÿæ–‡ä»¶è¢«å¿½ç•¥
        if grep -q "\.env$" .gitignore && grep -q "\.mp4$" .gitignore; then
          echo "âœ… Sensitive files are properly ignored"
        else
          echo "Error: .gitignore doesn't properly exclude sensitive files"
          exit 1
        fi
        
    - name: Check project structure
      run: |
        # éªŒè¯é¡¹ç›®ç»“æ„
        echo "Validating project structure..."
        required_files=(
          "setup-config.sh"
          "convert-to-hls.sh"
          "manage-cloudfront.sh"
          "verify-config.sh"
          "verify-security.sh"
          "enhanced-hls-player.html"
          "mediaconvert-job.json"
          "trust-policy.json"
          "permissions-policy.json"
          "s3-cors-config.json"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "Error: Required file $file is missing"
            exit 1
          fi
        done
        
        echo "âœ… All required files are present"
        
    - name: Summary
      run: |
        echo "ğŸ‰ Project validation completed successfully!"
        echo "âœ… Shell scripts syntax is valid"
        echo "âœ… JSON files are well-formed"
        echo "âœ… Documentation is complete"
        echo "âœ… Project structure is correct"
        echo "âœ… Configuration templates are present"
